"use strict";(self.webpackChunksudeeparyan_knowledgebase=self.webpackChunksudeeparyan_knowledgebase||[]).push([[487],{80620:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var s=r(74848),t=r(28453);const i={},o=void 0,a={id:"RAG360/Retrieval/Unstructured/Searching/Hybrid Search/Fusion Retriver",title:"Fusion Retriver",description:"1. So this fusion is basically a search methodology that aims to bridge the gap",source:"@site/docs/RAG360/Retrieval/Unstructured/Searching/Hybrid Search/Fusion Retriver.md",sourceDirName:"RAG360/Retrieval/Unstructured/Searching/Hybrid Search",slug:"/RAG360/Retrieval/Unstructured/Searching/Hybrid Search/Fusion Retriver",permalink:"/docs/RAG360/Retrieval/Unstructured/Searching/Hybrid Search/Fusion Retriver",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"ragSidebar",previous:{title:"Qdrant",permalink:"/docs/RAG360/Retrieval/Unstructured/Searching/Hybrid Search/Qdrant"},next:{title:"Meta-Data Filtering",permalink:"/docs/RAG360/Retrieval/Unstructured/Meta-Data Filtering"}},l={},d=[{value:"What the Fusion does",id:"what-the-fusion-does",level:3},{value:"QueryFusionRetriever",id:"queryfusionretriever",level:3},{value:"Simple Fusion",id:"simple-fusion",level:3},{value:"Reciprocal Fusion",id:"reciprocal-fusion",level:3},{value:"Detailed Observation",id:"detailed-observation",level:3}];function c(e){const n={admonition:"admonition",code:"code",h3:"h3",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"So this fusion is basically a search methodology that aims to bridge the gap\nbetween traditional search paradigms and the multifaced dimensions of human\nqueries."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The fusion concept is to employ multiple query generation and use the\nreranking system to re-rank the search results."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The main goal is to move closer to unearthing that elusive 90% of\ntransformative knowledge that often remains hidden behind top search results."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"what-the-fusion-does",children:"What the Fusion does"}),"\n",(0,s.jsxs)("table",{class:"table-size-for-cloud-services",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Process Step"}),(0,s.jsx)("th",{children:"Description"})]})}),(0,s.jsxs)("tbody",{children:[(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsx)("span",{class:"custom-header",children:"Query Generation"})}),(0,s.jsx)("td",{children:"The system starts by generating multiple queries from a user's initial query using OpenAI's GPT Model."})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsx)("span",{class:"custom-header",children:"Vector Search"})}),(0,s.jsx)("td",{children:"Conducts vector-based searches on each of the generated queries to retrieve relevant documents from a predefined set."})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsx)("span",{class:"custom-header",children:"ReRanking System"})}),(0,s.jsx)("td",{children:"Applies the re-ranking algorithm to re-rank the documents based on their relevance across multiple queries."})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:(0,s.jsx)("span",{class:"custom-header",children:"Output Generation"})}),(0,s.jsx)("td",{children:"Produces a final output consisting of the re-ranked list of documents."})]})]})]}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsx)(n.mdxAdmonitionTitle,{}),(0,s.jsx)(n.p,{children:"There are basically 2 types of fusion retrievers powered by Llama Index,\naccording to the re-rank algorithms."}),(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Simple Fusion Retriever"}),"\n",(0,s.jsx)(n.li,{children:"Reciprocal ReRank Fusion Retriever"}),"\n"]})]}),"\n",(0,s.jsx)(n.h3,{id:"queryfusionretriever",children:"QueryFusionRetriever"}),"\n",(0,s.jsx)(n.p,{children:"This QueryFusionRetriever is the retriever released by the Llama Index, which we\ncan use to combine more vector searches to retrieve the nodes and do the re-rank\nover the retrieved nodes which can be used later by the summary generation."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'class QueryFusionRetriever(BaseRetriever):\ndef __init__(\n        self,\n        retrievers: List[BaseRetriever],\n        llm: Optional[LLMType] = "default",\n        query_gen_prompt: Optional[str] = None,\n        mode: FUSION_MODES = FUSION_MODES.SIMPLE,\n        similarity_top_k: int = DEFAULT_SIMILARITY_TOP_K,\n        num_queries: int = 4,\n        use_async: bool = True,\n        verbose: bool = False,\n    )\n'})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"retrievers"})," we can have a list of various retrievers that we used to\nretrieve the top k nodes using different search techniques."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"query_gen_prompt"})," This prompt is used to generate multiple queries from\nuser's initial query. By default Llama Index have a prompt, if we need to use\nour own prompt we can just override it by passing out own prompt."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'QUERY_GEN_PROMPT = (\n    "You are a helpful assistant that generates multiple search queries based on a "\n    "single input query. Generate {num_queries} search queries, one on each line, "\n    "related to the following input query:\\n"\n    "Query: {query}\\n"\n    "Queries:\\n"\n)\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"mode"})," as we saw earlier, this fusion retriever has 2 modes simple and\nreciprocal reranking."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Simple - simple re-ordering of results based on the original score."}),"\n",(0,s.jsx)(n.li,{children:"Reciprocal - Apply the reciprocal re-rank algorithm."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"similarity_top_k"})," - after the reranking the retriever will retrieve the\ntop k nodes which are later used by the summary generator to generate the\noutput text."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"num_queries"})," - indicates how many queries have to be generated from the\ninitial user query. To disable this query generation, set this to 1."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"use_async"})," - If this is true, then only the nodes from the first\nretrievers will be passed down to the query fusion retriever. If this is\nfalse, then nodes from all the retrievers will be passed down to the query\nfusion retriever."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"simple-fusion",children:"Simple Fusion"}),"\n",(0,s.jsx)(n.p,{children:"The retrieved nodes will be returned as the top-k across all queries and\nindexes, as well as handling the de-duplication of any nodes. After that, it\nwill simply reorder with the already existing node score and take the top k\nnodes from it for the query fusion retriever."}),"\n",(0,s.jsx)(n.h3,{id:"reciprocal-fusion",children:"Reciprocal Fusion"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"The retrieved nodes will be returned as the top-k across all queries and\nindexes, as well as handling the de-duplication of any nodes."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Since all of these retrievers calculate a score, we can use the reciprocal\nrerank algorithm to re-sort our nodes without using an additional model or\nexcessive computation.\n",(0,s.jsx)(n.img,{alt:"FusionRetrieverReciprocal.png",src:r(15115).A+"",width:"701",height:"466"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"In Llama Index, the way the reciprocal re-ranking is designed like"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'def fuse_results(results_dict, similarity_top_k: int = 2):\n    """Fuse results."""\n    k = 60.0  # `k` is a parameter used to control the impact of outlier rankings.\n    fused_scores = {}\n    text_to_node = {}\n\n    # compute reciprocal rank scores\n    for nodes_with_scores in results_dict.values():\n        for rank, node_with_score in enumerate(\n            sorted(\n                nodes_with_scores, key=lambda x: x.score or 0.0, reverse=True\n            )\n        ):\n            text = node_with_score.node.get_content()\n            text_to_node[text] = node_with_score\n            if text not in fused_scores:\n                fused_scores[text] = 0.0\n            fused_scores[text] += 1.0 / (rank + k)\n\n    # sort results\n    reranked_results = dict(\n        sorted(fused_scores.items(), key=lambda x: x[1], reverse=True)\n    )\n\n    # adjust node scores\n    reranked_nodes: List[NodeWithScore] = []\n    for text, score in reranked_results.items():\n        reranked_nodes.append(text_to_node[text])\n        reranked_nodes[-1].score = score\n\n    return reranked_nodes[:similarity_top_k]\n'})}),"\n",(0,s.jsx)(n.h3,{id:"detailed-observation",children:"Detailed Observation"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"FusionRetrieverObservation.png",src:r(66313).A+"",width:"1736",height:"204"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},66313:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/FusionRetrieverObservation-9d52a0967b56324f19314214c0c737f1.png"},15115:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/FusionRetrieverReciprocal-cc234599fbd1d34f419a427b7a4eedb1.png"},28453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>a});var s=r(96540);const t={},i=s.createContext(t);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);